#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
# description: Uprobe event parser error log check

[ -f uprobe_events ] || exit_unsupported # this is configurable

[ -f error_log ] || exit_unsupported

check_error() { # command-with-error-pos-by-^
pos=$(echo -n "${1%^*}" | wc -c) # error position
command=$(echo "$1" | tr -d ^)
echo "Test command: $command"
echo > error_log
(! echo "$command" > uprobe_events ) 2> /dev/null
grep "trace_uprobe: error:" -A 3 error_log
N=$(tail -n 1 error_log | wc -c)
# "  Command: " and "^\n" => 13
test $(expr 13 + $pos) -eq $N
}

check_error 'p ^/non_exist_file:100'	# FILE_NOT_FOUND
check_error 'p ^/sys:100'		# NO_REGULAR_FILE
check_error 'p /bin/sh:^10a'		# BAD_UPROBE_OFFS
check_error 'p /bin/sh:10(^1a)'		# BAD_REFCNT
check_error 'p /bin/sh:10(10^'		# REFCNT_OPEN_BRACE
check_error 'p /bin/sh:10(10)^a'	# BAD_REFCNT_SUFFIX

check_error 'p /bin/sh:10 ^@+ab'	# BAD_FILE_OFFS
check_error 'p /bin/sh:10 ^@symbol'	# SYM_ON_UPROBE

exit 0
